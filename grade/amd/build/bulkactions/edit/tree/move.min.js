define("core_grades/bulkactions/edit/tree/move",["exports","core/bulkactions/bulk_action","core/str","core/modal_factory","core/notification","core/templates","core/ajax","jquery","core/modal_events"],(function(_exports,_bulk_action,_str,_modal_factory,_notification,_templates,_ajax,_jquery,_modal_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_bulk_action=_interopRequireDefault(_bulk_action),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_jquery=_interopRequireDefault(_jquery),_modal_events=_interopRequireDefault(_modal_events);const Selectors_editTreeForm="#gradetreeform",Selectors_gradeTreeSection='#destination-selector [role="tree"] [data-for="sectionnode"][role="treeitem"]',Selectors_gradeTreeItem='#destination-selector [role="tree"] [role="treeitem"]',Selectors_gradeTreeSectionVisibilityToggle='#destination-selector [role="tree"] .collapse-list-link',Selectors_gradeTreeSectionContent='#destination-selector [role="tree"] .collapse-list-item-content',Selectors_bulkMoveInput='input[name="bulkmove"]',Selectors_bulkMoveAfterInput='input[name="moveafter"]';class GradebookEditTreeBulkMove extends _bulk_action.default{constructor(courseID){super(),_defineProperty(this,"courseID",null),_defineProperty(this,"modal",null),_defineProperty(this,"visibleGradeTreeItems",null),_defineProperty(this,"selectedGradeTreeItem",null),_defineProperty(this,"gradeTree",null),this.courseID=courseID}getBulkActionTriggerSelector(){return'button[data-action="move"]'}async triggerBulkAction(){this.modal=await this.showModal(),this.setVisibleGradeTreeItems()}async renderBulkActionTrigger(){return _templates.default.render("core_grades/bulkactions/edit/tree/bulk_move_trigger",{})}registerCustomListenerEvents(){document.addEventListener("click",(e=>{e.target.closest(Selectors_gradeTreeItem)&&!e.target.closest(Selectors_gradeTreeSectionVisibilityToggle)&&(this.selectGradeTreeItem(e.target.closest(Selectors_gradeTreeItem)),this.modal.setButtonDisabled("save",!1))})),(0,_jquery.default)(Selectors_gradeTreeSectionContent).on("hidden.bs.collapse shown.bs.collapse",(()=>{this.setVisibleGradeTreeItems()})),document.addEventListener("keydown",(e=>{const currentGradeTreeItem=e.target.closest(Selectors_gradeTreeItem);if(currentGradeTreeItem)switch(e.key){case"ArrowRight":currentGradeTreeItem.matches(Selectors_gradeTreeSection)&&this.collapseGradeCategory(currentGradeTreeItem,!1);break;case"ArrowLeft":currentGradeTreeItem.matches(Selectors_gradeTreeSection)&&this.collapseGradeCategory(currentGradeTreeItem,!0);break;case"ArrowDown":this.moveToNextGradeTreeItem(currentGradeTreeItem);break;case"ArrowUp":this.moveToPreviousGradeTreeItem(currentGradeTreeItem);break;case"Home":this.moveToFirstGradeTreeItem();break;case"End":this.moveToLastGradeTreeItem();break;case"Enter":case" ":this.selectGradeTreeItem(currentGradeTreeItem),this.modal.setButtonDisabled("save",!1)}}))}fetchGradeTree(){const request={methodname:"core_grades_get_grade_tree",args:{courseid:this.courseID}};return _ajax.default.call([request])[0]}async showModal(){return null===this.gradeTree&&(this.gradeTree=await this.fetchGradeTree()),_modal_factory.default.create({title:await(0,_str.get_string)("movesitems","grades"),body:await _templates.default.render("core_grades/bulkactions/edit/tree/bulk_move_grade_tree",JSON.parse(this.gradeTree)),buttons:{save:await(0,_str.get_string)("move")},large:!0,type:_modal_factory.default.types.SAVE_CANCEL}).then((modal=>(modal.show(),modal.setButtonDisabled("save",!0),modal.getBody()[0].querySelector(Selectors_gradeTreeSection).tabIndex=0,modal.getRoot().on(_modal_events.default.save,(()=>{document.querySelector(Selectors_bulkMoveInput).value=1,document.querySelector(Selectors_bulkMoveAfterInput).value=this.selectedGradeTreeItem.dataset.id,document.querySelector(Selectors_editTreeForm).submit()})),modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),modal))).catch(_notification.default.exception)}collapseGradeCategory(gradeCategorySection,setCollapsed){const sectionContent=gradeCategorySection.querySelector(Selectors_gradeTreeSectionContent);setCollapsed?(0,_jquery.default)(sectionContent).collapse("hide"):(0,_jquery.default)(sectionContent).collapse("show")}moveToNextGradeTreeItem(gradeTreeItem){const currentGradeTreeItemIndex=this.visibleGradeTreeItems.findIndex((item=>item===gradeTreeItem));this.focusGradeTreeItem(this.visibleGradeTreeItems[currentGradeTreeItemIndex+1])}moveToPreviousGradeTreeItem(gradeTreeItem){const currentGradeTreeItemIndex=this.visibleGradeTreeItems.findIndex((item=>item===gradeTreeItem));this.focusGradeTreeItem(this.visibleGradeTreeItems[currentGradeTreeItemIndex-1])}moveToFirstGradeTreeItem(){this.focusGradeTreeItem(this.visibleGradeTreeItems[0])}moveToLastGradeTreeItem(){this.focusGradeTreeItem(this.visibleGradeTreeItems[this.visibleGradeTreeItems.length-1])}selectGradeTreeItem(gradeTreeItem){document.querySelectorAll(Selectors_gradeTreeItem).forEach((item=>{item.dataset.selected="false"})),gradeTreeItem.dataset.selected="true",this.selectedGradeTreeItem=gradeTreeItem}focusGradeTreeItem(gradeTreeItem){gradeTreeItem&&gradeTreeItem.focus()}setVisibleGradeTreeItems(){const allGradeTreeItems=Array.from(this.modal.getBody()[0].querySelectorAll(Selectors_gradeTreeItem));this.visibleGradeTreeItems?this.visibleGradeTreeItems=allGradeTreeItems.filter((gradeTreeItem=>gradeTreeItem.offsetWidth>0&&gradeTreeItem.offsetHeight>0)):this.visibleGradeTreeItems=allGradeTreeItems}}return _exports.default=GradebookEditTreeBulkMove,_exports.default}));

//# sourceMappingURL=move.min.js.map