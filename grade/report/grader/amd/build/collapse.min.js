define("gradereport_grader/collapse",["exports","gradereport_grader/collapse/repository","core/notification","gradereport_grader/search/search_class","core/templates","core/utils","jquery","core/str"],(function(_exports,Repository,_notification,_search_class,_templates,_utils,_jquery,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _defineProperty(obj,key,value){return(key=function(arg){var key=function(input,hint){if("object"!=typeof input||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0!==prim){var res=prim.call(input,hint||"default");if("object"!=typeof res)return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===hint?String:Number)(input)}(arg,"string");return"symbol"==typeof key?key:String(key)}(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Repository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Repository),_notification=_interopRequireDefault(_notification),_search_class=_interopRequireDefault(_search_class),_jquery=_interopRequireDefault(_jquery);const selectors_component=".collapse-columns",selectors_formDropdown=".columnsdropdownform",selectors_formItems={type:"submit",save:"save",cancel:"cancel"},selectors_hider="hide",selectors_expand="expand",selectors_colVal="[data-col]",selectors_itemVal="[data-itemid]",selectors_content='[data-collapse="content"]',selectors_expandbutton='[data-collapse="expandbutton"]',selectors_menu='[data-collapse="menu"]',selectors_count='[data-collapse="count"]',selectors_placeholder='.collapsecolumndropdown [data-region="placeholder"]',countIndicator=document.querySelector(selectors_count);class ColumnSearch extends _search_class.default{static init(userID,courseID){return new ColumnSearch(userID,courseID)}constructor(userID,courseID){super(),_defineProperty(this,"userID",-1),_defineProperty(this,"courseID",null),_defineProperty(this,"nodes",[]),_defineProperty(this,"gradeStrings",null),_defineProperty(this,"userStrings",null),_defineProperty(this,"stringMap",[]),this.userID=userID,this.courseID=courseID,this.renderDefault()}setComponentSelector(){return".collapse-columns"}setDropdownSelector(){return".searchresultitemscontainer"}setTriggerSelector(){return".collapsecolumn"}async getDataset(){if(!this.dataset){var _cols$0$value$split,_cols$0$value;const cols=await this.fetchDataset();this.dataset=null!==(_cols$0$value$split=null===(_cols$0$value=cols[0].value)||void 0===_cols$0$value?void 0:_cols$0$value.split(","))&&void 0!==_cols$0$value$split?_cols$0$value$split:[]}return this.datasetSize=this.dataset.length,this.dataset}async docClickHandler(e){var _e$target$closest3;const ds=await this.getDataset();if(e.target.dataset.hider===selectors_hider){var _e$target$closest,_e$target$closest2;e.preventDefault();const desiredToHide=e.target.closest(selectors_colVal)?null===(_e$target$closest=e.target.closest(selectors_colVal))||void 0===_e$target$closest?void 0:_e$target$closest.dataset.col:null===(_e$target$closest2=e.target.closest(selectors_itemVal))||void 0===_e$target$closest2?void 0:_e$target$closest2.dataset.itemid;-1===ds.indexOf(desiredToHide)&&ds.push(desiredToHide),this.setPreferences(),countIndicator.textContent=this.getDatasetSize(),this.setMatchedResults(await this.filterDataset(await this.getDataset())),await this.filterMatchDataset(),await this.renderDropdown();const colNodesToHide=[...document.querySelectorAll('[data-col="'.concat(desiredToHide,'"]'))],itemIDNodesToHide=[...document.querySelectorAll('[data-itemid="'.concat(desiredToHide,'"]'))];this.nodes=[...colNodesToHide,...itemIDNodesToHide],this.updateDisplay()}if((null===(_e$target$closest3=e.target.closest("button"))||void 0===_e$target$closest3?void 0:_e$target$closest3.dataset.hider)===selectors_expand){var _e$target$closest4,_e$target$closest5,_e$target$closest6,_e$target$closest7;const desiredToHide=e.target.closest(selectors_colVal)?null===(_e$target$closest4=e.target.closest(selectors_colVal))||void 0===_e$target$closest4?void 0:_e$target$closest4.dataset.col:null===(_e$target$closest5=e.target.closest(selectors_itemVal))||void 0===_e$target$closest5?void 0:_e$target$closest5.dataset.itemid,idx=ds.indexOf(desiredToHide);ds.splice(idx,1),this.setPreferences(),countIndicator.textContent=this.getDatasetSize();const colNodesToHide=[...document.querySelectorAll('[data-col="'.concat(null===(_e$target$closest6=e.target.closest(selectors_colVal))||void 0===_e$target$closest6?void 0:_e$target$closest6.dataset.col,'"]'))],itemIDNodesToHide=[...document.querySelectorAll('[data-itemid="'.concat(null===(_e$target$closest7=e.target.closest(selectors_itemVal))||void 0===_e$target$closest7?void 0:_e$target$closest7.dataset.itemid,'"]'))];this.nodes=[...colNodesToHide,...itemIDNodesToHide],this.updateDisplay()}}async renderDropdown(){const{html:html,js:js}=await(0,_templates.renderForPromise)("gradereport_grader/collapse/collapseresults",{results:this.getMatchedResults(),searchTerm:this.getSearchTerm()});(0,_templates.replaceNodeContents)(this.getHTMLElements().searchDropdown,html,js)}async filterDataset(filterableData){const stringMap=await this.fetchRequiredUserStrings(),stringGradeMap=await this.fetchRequiredGradeStrings();this.stringMap=new Map([...stringMap,...stringGradeMap]);const searching=filterableData.map((s=>{var _mapObj$itemname,_mapObj$category;const mapObj=this.stringMap.get(s);return{key:s,string:null!==(_mapObj$itemname=mapObj.itemname)&&void 0!==_mapObj$itemname?_mapObj$itemname:this.stringMap.get(s),category:null!==(_mapObj$category=mapObj.category)&&void 0!==_mapObj$category?_mapObj$category:""}}));return""===this.getPreppedSearchTerm()?searching:searching.filter((col=>col.string.toString().toLowerCase().includes(this.getPreppedSearchTerm())))}async filterMatchDataset(){this.setMatchedResults(this.getMatchedResults().map((column=>{var _column$string,_column$category;return{name:column.key,displayName:null!==(_column$string=column.string)&&void 0!==_column$string?_column$string:column.key,category:null!==(_column$category=column.category)&&void 0!==_column$category?_column$category:""}})))}fetchDataset(){return Repository.prefFetch(this.userID).then((r=>r.preferences)).catch(_notification.default.exception)}updateNodes(){this.component=document.querySelector(selectors_component),super.updateNodes()}registerInputEvents(){this.searchInput.addEventListener("input",(0,_utils.debounce)((async()=>{this.setSearchTerms(this.searchInput.value),""===this.searchInput.value?this.clearSearchButton.classList.add("d-none"):this.clearSearchButton.classList.remove("d-none"),this.setMatchedResults(await this.filterDataset(await this.getDataset())),await this.filterMatchDataset(),this.updateNodes(),await this.renderDropdown()}),300))}registerClickHandlers(){this.component.addEventListener("click",this.clickHandler.bind(this)),document.addEventListener("click",this.docClickHandler.bind(this))}registerFormEvents(){const form=this.component.querySelector(selectors_formDropdown);form.addEventListener("submit",(async e=>{if(e.preventDefault(),e.submitter.dataset.action===selectors_formItems.cancel)return void(0,_jquery.default)(this.component).dropdown("toggle");const checkedItems=[...form.elements].filter((item=>item.checked)),ds=await this.getDataset();checkedItems.forEach((item=>{const idx=ds.indexOf(item.dataset.collapse);ds.splice(idx,1);const colNodesToHide=[...document.querySelectorAll('[data-col="'.concat(item.dataset.collapse,'"]'))],itemIDNodesToHide=[...document.querySelectorAll('[data-itemid="'.concat(item.dataset.collapse,'"]'))];this.nodes=[...colNodesToHide,...itemIDNodesToHide],this.updateDisplay()})),await this.setPreferences(),this.setMatchedResults(await this.filterDataset(await this.getDataset())),await this.filterMatchDataset(),await this.renderDropdown(),countIndicator.textContent=this.getDatasetSize()}),!1)}updateDisplay(){this.nodes.forEach((element=>{const content=element.querySelector(selectors_content),menu=element.querySelector(selectors_menu),expandButton=element.querySelector(selectors_expandbutton);element.classList.contains("cell")&&(content.classList.contains("d-none")?(element.classList.remove("collapsed"),content.classList.remove("d-none"),content.setAttribute("aria-hidden","false"),null==menu||menu.classList.remove("d-none"),null==menu||menu.setAttribute("aria-hidden","false"),null==expandButton||expandButton.classList.add("d-none"),null==expandButton||expandButton.setAttribute("aria-hidden","true")):(element.classList.add("collapsed"),content.classList.add("d-none"),content.setAttribute("aria-hidden","true"),null==menu||menu.classList.add("d-none"),null==menu||menu.setAttribute("aria-hidden","true"),null==expandButton||expandButton.classList.remove("d-none"),null==expandButton||expandButton.setAttribute("aria-hidden","false")))}))}async setPreferences(){const ds=await this.getDataset(),preferences=[{name:"grade_report_grader_collapsed_columns",value:"".concat(ds.join(",")),userid:this.userID}];Repository.prefSet(preferences)}fetchRequiredGradeStrings(){return this.gradeStrings||(this.gradeStrings=Repository.gradeItems(this.courseID).then((result=>new Map(result.gradeitems.map((key=>[key.id,key])))))),this.gradeStrings}async renderDefault(){this.setMatchedResults(await this.filterDataset(await this.getDataset())),await this.filterMatchDataset(),countIndicator.textContent=this.getDatasetSize();const{html:html,js:js}=await(0,_templates.renderForPromise)("gradereport_grader/collapse/collapsebody",{results:this.getMatchedResults(),userid:this.userID});(0,_templates.replaceNode)(selectors_placeholder,html,js),this.updateNodes(),this.registerFormEvents(),this.registerInputEvents()}fetchRequiredUserStrings(){if(!this.userStrings){const requiredStrings=["username","firstname","lastname","email","city","country","department","institution","idnumber","phone1","phone2"];this.userStrings=(0,_str.get_strings)(requiredStrings.map((key=>({key:key})))).then((stringArray=>new Map(requiredStrings.map(((key,index)=>[key,stringArray[index]])))))}return this.userStrings}}return _exports.default=ColumnSearch,_exports.default}));

//# sourceMappingURL=collapse.min.js.map