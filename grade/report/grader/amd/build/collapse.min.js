define("gradereport_grader/collapse",["exports","core/pending","core/custom_interaction_events","gradereport_grader/collapse/repository","core/notification","core/templates","core/utils","jquery","core/str"],(function(_exports,_pending,_custom_interaction_events,Repository,_notification,Templates,_utils,_jquery,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Allow the user to show and hide columns of the report at will.
   *
   * @module    gradereport_grader/collapse
   * @copyright 2023 Mathew May <mathew.solutions>
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let userPrefs,colsToHide;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_pending=_interopRequireDefault(_pending),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events),Repository=_interopRequireWildcard(Repository),_notification=_interopRequireDefault(_notification),Templates=_interopRequireWildcard(Templates),_jquery=_interopRequireDefault(_jquery);const selectors_component=".collapse-columns",selectors_input='[data-action="search"]',selectors_clearSearch='[data-action="clearsearch"]',selectors_resultContainer='[data-region="search-result-items-container"]',selectors_userid='[data-region="userid"]',selectors_formDropdown=".columnsdropdownform",selectors_formItems={type:"submit",save:"save",cancel:"cancel"},selectors_hider="hide",selectors_expand="expand",selectors_colVal="[data-col]",selectors_itemVal="[data-itemid]",selectors_content='[data-collapse="content"]',selectors_expandbutton='[data-collapse="expandbutton"]',selectors_menu='[data-collapse="menu"]';let component,searchInput,clearSearchButton,resultContainer,userID;const selectorUpdate=()=>{component=document.querySelector(selectors_component),searchInput=component.querySelector(selectors_input),clearSearchButton=component.querySelector(selectors_clearSearch),resultContainer=component.querySelector(selectors_resultContainer),userID=component.querySelector(selectors_userid).dataset.userid};let profilestringmap=[];const setPreferences=()=>{const preferences=[{name:"gradereport_grader_collapsed_columns",value:"".concat(colsToHide.join(",")),userid:userID}];Repository.prefSet(preferences)},updateDisplay=nodes=>{nodes.forEach((element=>{const content=element.querySelector(selectors_content),menu=element.querySelector(selectors_menu),expandButton=element.querySelector(selectors_expandbutton);element.classList.contains("cell")&&(content.classList.contains("d-none")?(element.classList.remove("collapsed"),content.classList.remove("d-none"),content.setAttribute("aria-hidden","false"),null==menu||menu.classList.remove("d-none"),null==menu||menu.setAttribute("aria-hidden","false"),null==expandButton||expandButton.classList.add("d-none"),null==expandButton||expandButton.setAttribute("aria-hidden","true")):(element.classList.add("collapsed"),content.classList.add("d-none"),content.setAttribute("aria-hidden","true"),null==menu||menu.classList.add("d-none"),null==menu||menu.setAttribute("aria-hidden","true"),null==expandButton||expandButton.classList.remove("d-none"),null==expandButton||expandButton.setAttribute("aria-hidden","false")))}))},registerFormEvents=()=>{const form=component.querySelector(selectors_formDropdown);form.addEventListener("submit",(async e=>{if(e.preventDefault(),e.submitter.dataset.action===selectors_formItems.cancel)return void(0,_jquery.default)(component).dropdown("toggle");[...form.elements].filter((item=>item.checked)).forEach((item=>{const idx=colsToHide.indexOf(item.dataset.collapse);colsToHide.splice(idx,1);const colNodesToHide=[...document.querySelectorAll('[data-col="'.concat(item.dataset.collapse,'"]'))],itemIDNodesToHide=[...document.querySelectorAll('[data-itemid="'.concat(item.dataset.collapse,'"]'))];updateDisplay([...colNodesToHide,...itemIDNodesToHide])})),await setPreferences();const filteredResults=filter(colsToHide,searchInput.value),filtermatchResults=filterMatchIndicator(filteredResults);await render(filtermatchResults,colsToHide,userID,resultContainer,searchInput.value)}),!1)},registerListenerEvents=()=>{const events=["click",_custom_interaction_events.default.events.activate,_custom_interaction_events.default.events.keyboardActivate];_custom_interaction_events.default.define(document,events),events.forEach((event=>{document.addEventListener(event,(e=>(async e=>{var _e$target$closest3;if(e.target.dataset.hider===selectors_hider){var _e$target$closest,_e$target$closest2;e.preventDefault();const desiredToHide=e.target.closest(selectors_colVal)?null===(_e$target$closest=e.target.closest(selectors_colVal))||void 0===_e$target$closest?void 0:_e$target$closest.dataset.col:null===(_e$target$closest2=e.target.closest(selectors_itemVal))||void 0===_e$target$closest2?void 0:_e$target$closest2.dataset.itemid;-1===colsToHide.indexOf(desiredToHide)&&colsToHide.push(desiredToHide),setPreferences();const filteredResults=filter(colsToHide,searchInput.value),filtermatchResults=filterMatchIndicator(filteredResults);await render(filtermatchResults,colsToHide,userID,resultContainer,searchInput.value);const colNodesToHide=[...document.querySelectorAll('[data-col="'.concat(desiredToHide,'"]'))],itemIDNodesToHide=[...document.querySelectorAll('[data-itemid="'.concat(desiredToHide,'"]'))];updateDisplay([...colNodesToHide,...itemIDNodesToHide])}if((null===(_e$target$closest3=e.target.closest("button"))||void 0===_e$target$closest3?void 0:_e$target$closest3.dataset.hider)===selectors_expand){var _e$target$closest4,_e$target$closest5,_e$target$closest6,_e$target$closest7;const desiredToHide=e.target.closest(selectors_colVal)?null===(_e$target$closest4=e.target.closest(selectors_colVal))||void 0===_e$target$closest4?void 0:_e$target$closest4.dataset.col:null===(_e$target$closest5=e.target.closest(selectors_itemVal))||void 0===_e$target$closest5?void 0:_e$target$closest5.dataset.itemid,idx=colsToHide.indexOf(desiredToHide);colsToHide.splice(idx,1),setPreferences();const colNodesToHide=[...document.querySelectorAll('[data-col="'.concat(null===(_e$target$closest6=e.target.closest(selectors_colVal))||void 0===_e$target$closest6?void 0:_e$target$closest6.dataset.col,'"]'))],itemIDNodesToHide=[...document.querySelectorAll('[data-itemid="'.concat(null===(_e$target$closest7=e.target.closest(selectors_itemVal))||void 0===_e$target$closest7?void 0:_e$target$closest7.dataset.itemid,'"]'))];updateDisplay([...colNodesToHide,...itemIDNodesToHide])}})(e)))}))},registerInputEvents=()=>{searchInput.addEventListener("input",(0,_utils.debounce)((async()=>{""===searchInput.value?clearSearchButton.classList.add("d-none"):clearSearchButton.classList.remove("d-none");const filteredResults=filter(colsToHide,searchInput.value),filtermatchResults=filterMatchIndicator(filteredResults);await render(filtermatchResults,colsToHide,userID,resultContainer,searchInput.value)}),300))};_exports.init=async(userID,courseID)=>{var _userPrefs$0$value$sp,_userPrefs$0$value;const pendingPromise=new _pending.default,gradeItem=await Repository.gradeItems(courseID).then((result=>new Map(result.gradeitems.map((key=>[key.id,key.itemname])))));profilestringmap=await(()=>{const requiredStrings=["username","firstname","lastname","email","city","country","department","institution","idnumber","phone1","phone2"];return(0,_str.get_strings)(requiredStrings.map((key=>({key:key})))).then((stringArray=>new Map(requiredStrings.map(((key,index)=>[key,stringArray[index]])))))})(),profilestringmap=new Map([...profilestringmap,...gradeItem]),userPrefs=await fetchFilterbleData(userID),colsToHide=null!==(_userPrefs$0$value$sp=null===(_userPrefs$0$value=userPrefs[0].value)||void 0===_userPrefs$0$value?void 0:_userPrefs$0$value.split(","))&&void 0!==_userPrefs$0$value$sp?_userPrefs$0$value$sp:[],await renderDefault(filterMatchIndicator(colsToHide),userID),selectorUpdate(),registerListenerEvents(),registerInputEvents(),registerFormEvents(),pendingPromise.resolve()};const fetchFilterbleData=userID=>Repository.prefFetch(userID).then((r=>r.preferences)).catch(_notification.default.exception),filter=(dataset,searchTerm)=>{const preppedSearchTerm=searchTerm.toLowerCase();return dataset.filter((col=>""!==col&&col.toString().toLowerCase().includes(preppedSearchTerm)))},filterMatchIndicator=matchedResultsSubset=>matchedResultsSubset.map((column=>{var _profilestringmap$get;return{name:column,displayName:null!==(_profilestringmap$get=profilestringmap.get(column))&&void 0!==_profilestringmap$get?_profilestringmap$get:column}})),render=async(results,dataset,userID,resultContainer,searchTerm)=>{const{html:html,js:js}=await Templates.renderForPromise("gradereport_grader/collapse/collapseresults",{results:results,searchTerm:searchTerm});Templates.replaceNodeContents(resultContainer,html,js)},renderDefault=async(filtermatchResults,userID)=>{const{html:html,js:js}=await Templates.renderForPromise("gradereport_grader/collapse/collapsebody",{results:filtermatchResults,userid:userID});Templates.replaceNodeContents('.collapsecolumndropdown [data-region="placeholder"]',html,js)}}));

//# sourceMappingURL=collapse.min.js.map