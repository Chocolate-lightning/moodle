define("gradereport_grader/search",["exports","jquery","core/notification","core/pending","core/custom_interaction_events","core/key_codes","core/templates","core/utils","gradereport_grader/search/repository","core/str","core/url"],(function(_exports,_jquery,_notification,_pending,_custom_interaction_events,_key_codes,Templates,_utils,Repository,_str,_url){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Allow the user to search for learners within the grader report.
   * Have to basically search twice on the dataset to avoid passing around massive csv params whilst allowing debouncing.
   *
   * @module    gradereport_grader/search
   * @copyright 2022 Mathew May <mathew.solutions>
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_pending=_interopRequireDefault(_pending),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events),Templates=_interopRequireWildcard(Templates),Repository=_interopRequireWildcard(Repository),_url=_interopRequireDefault(_url);let registered=!1,profilestringmap=null;const bannedFilterFields=["profileimageurlsmall","profileimageurl","id","link","matchingField","matchingFieldName"],selectAllResultsLink=function(searchTerm,courseID){let userID=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const params={id:courseID,searchvalue:searchTerm};return null!==userID&&(params.userid=userID),_url.default.relativeUrl("/grade/report/grader/index.php",params,!1)};let searchTerm="";const selectors_component=".user-search",selectors_courseid='[data-region="courseid"]',selectors_trigger=".usersearchwidget",selectors_input='[data-action="search"]',selectors_clearSearch='[data-action="clearsearch"]',selectors_dropdown=".usersearchdropdown",selectors_resultitems='[role="menuitem"]',selectors_viewall="#select-all";_exports.init=async()=>{if(registered)return;const pendingPromise=new _pending.default,component=document.querySelector(selectors_component),courseID=component.querySelector(selectors_courseid).dataset.courseid;await fetchStrings();const userData=await Repository.userFetch(courseID).catch(_notification.default.exception);registerListenerEvents(userData.users,component,courseID),pendingPromise.resolve(),registered=!0};const fetchStrings=async()=>{const requiredStrings=["username","firstname","lastname","email","city","country","department","institution","idnumber","phone1","phone2"];profilestringmap=await(0,_str.get_strings)(requiredStrings.map((key=>({key:key})))).then((stringArray=>new Map(requiredStrings.map(((key,index)=>[key,stringArray[index]]))))).catch(_notification.default.exception)},registerListenerEvents=(users,component,courseID)=>{const events=["click","keydown",_custom_interaction_events.default.events.activate,_custom_interaction_events.default.events.keyboardActivate];_custom_interaction_events.default.define(document,events);const searchInput=component.querySelector(selectors_input),searchDropdown=component.querySelector(selectors_dropdown),$searchButton=(0,_jquery.default)(selectors_trigger),clearSearchButton=component.querySelector(selectors_clearSearch),closeSearch=()=>{dropdownHandler(component,$searchButton,searchDropdown),clearSearchButton.classList.add("d-none"),searchInput.value=""};$searchButton.on("click",(()=>{dropdownHandler(component,$searchButton,searchDropdown)})),events.forEach((event=>{component.addEventListener(event,(e=>{const resultnodes=[...component.querySelectorAll(selectors_resultitems)],current=resultnodes.find((r=>r.id===document.activeElement.id)),viewAll=component.querySelector(selectors_viewall);switch(e.target.closest(".dropdown-item")&&1===e.which&&(window.location=e.target.closest(".dropdown-item").href),e.target!==viewAll||e.which!==_key_codes.enter&&e.which!==_key_codes.space&&1!==e.which||(window.location=selectAllResultsLink(searchTerm,courseID)),e.target.closest(selectors_clearSearch)&&1===e.which&&(closeSearch(),searchInput.focus({preventScroll:!0})),e.which){case _key_codes.arrowUp:if(e.preventDefault(),e.stopPropagation(),document.activeElement===searchInput&&resultnodes.length>0&&resultnodes[resultnodes.length-1].focus({preventScroll:!0}),current){const index=resultnodes.indexOf(current);0===index?resultnodes[resultnodes.length-1].focus({preventScroll:!0}):resultnodes[index-1].focus({preventScroll:!0})}break;case _key_codes.arrowDown:if(e.preventDefault(),e.stopPropagation(),document.activeElement===searchInput&&resultnodes.length>0&&resultnodes[0].focus({preventScroll:!0}),current){const index=resultnodes.indexOf(current);index+1>=resultnodes.length?resultnodes[0].focus({preventScroll:!0}):resultnodes[index+1].focus({preventScroll:!0})}break;case _key_codes.home:e.preventDefault(),resultnodes.length>0&&resultnodes[0].focus({preventScroll:!0});break;case _key_codes.end:e.preventDefault(),resultnodes.length>0&&resultnodes[resultnodes.length-1].focus({preventScroll:!0});break;case _key_codes.escape:dropdownHandler(component,$searchButton,searchDropdown),searchInput.focus({preventScroll:!0});break;case _key_codes.enter:case _key_codes.space:if(document.activeElement===searchInput){if(e.which===_key_codes.space)break;window.location=selectAllResultsLink(searchTerm,courseID);break}if(document.activeElement===clearSearchButton){closeSearch();break}e.preventDefault(),window.location=e.target.closest(".dropdown-item").href;break;case _key_codes.tab:e.target.closest(selectors_clearSearch)&&(viewAll?(e.preventDefault(),viewAll.focus({preventScroll:!0})):closeSearch()),e.target.closest(selectors_viewall)&&closeSearch()}})),document.addEventListener(event,(e=>{!e.target.closest(selectors_component)&&searchDropdown.classList.contains("show")&&dropdownHandler(component,$searchButton,searchDropdown)}))})),searchInput.addEventListener("input",(0,_utils.debounce)((async()=>{searchTerm=searchInput.value,""===searchTerm?(dropdownHandler(component,$searchButton,searchDropdown),clearSearchButton.classList.add("d-none")):(clearSearchButton.classList.remove("d-none"),await makeDropdownBodyContent(users.length,filterUsers(searchTerm,users,courseID),searchTerm,component,courseID,searchDropdown),dropdownHandler(component,$searchButton,searchDropdown,!0))}),300))},dropdownHandler=function(component,$searchButton,searchDropdown){let on=arguments.length>3&&void 0!==arguments[3]&&arguments[3];(0,_jquery.default)(component).dropdown("toggle"),$searchButton.attr("aria-expanded",on),on?(searchDropdown.classList.add("show"),(0,_jquery.default)(searchDropdown).show()):(searchDropdown.classList.remove("show"),(0,_jquery.default)(searchDropdown).hide())},filterUsers=(searchTerm,users,courseID)=>{if(""===searchTerm)return users;const preppedSearchTerm=searchTerm.toLowerCase();return users.filter((user=>Object.keys(user).some((key=>{if(""===user[key]||bannedFilterFields.includes(key))return!1;{const hasTerm=user[key].toString().toLowerCase().includes(preppedSearchTerm);if(hasTerm){const str=user[key].toString().toLowerCase();user.matchingFieldName=profilestringmap.get(key)?profilestringmap.get(key):key,user.matchingField=str.replace(preppedSearchTerm,'<span class="font-weight-bold">'.concat(searchTerm,"</span>")),user.link=selectAllResultsLink(searchTerm,courseID,user.id)}return hasTerm}}))))},makeDropdownBodyContent=async(datasetSize,userData,searchTerm,component,courseID,searchDropdown)=>{const{html:html,js:js}=await Templates.renderForPromise("gradereport_grader/search/resultset",{users:userData.slice(0,20),hasusers:userData.length>0,total:datasetSize,found:userData.length,searchterm:searchTerm,selectall:selectAllResultsLink(searchTerm,courseID)});Templates.replaceNodeContents(searchDropdown,html,js)}}));

//# sourceMappingURL=search.min.js.map