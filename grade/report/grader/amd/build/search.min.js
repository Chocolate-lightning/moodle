define("gradereport_grader/search",["exports","gradereport_grader/search/search_class","gradereport_grader/search/repository","core/str","core/url","core/templates"],(function(_exports,_search_class,Repository,_str,_url,Templates){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return(key=function(arg){var key=function(input,hint){if("object"!=typeof input||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0!==prim){var res=prim.call(input,hint||"default");if("object"!=typeof res)return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===hint?String:Number)(input)}(arg,"string");return"symbol"==typeof key?key:String(key)}(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_search_class=_interopRequireDefault(_search_class),Repository=_interopRequireWildcard(Repository),_url=_interopRequireDefault(_url),Templates=_interopRequireWildcard(Templates);const bannedFilterFields=["profileimageurlsmall","profileimageurl","id","link","matchingField","matchingFieldName"],selectors_component=".user-search",selectors_courseid='[data-region="courseid"]',courseID=document.querySelector(selectors_component).querySelector(selectors_courseid).dataset.courseid;class UserSearch extends _search_class.default{constructor(){super(),_defineProperty(this,"profilestringmap",null)}async renderDropdown(){const{html:html,js:js}=await Templates.renderForPromise("gradereport_grader/search/resultset",{users:this.results,hasusers:this.results.length>0,total:this.dataset.length,found:this.results.length,searchterm:this.searchTerm,selectall:this.selectAllResultsLink()});Templates.replaceNodeContents(this.searchDropdown,html,js)}fetchDataset(){return Repository.userFetch(courseID).then((r=>r.users))}async filterDataset(){return this.dataset=this.dataset||await this.fetchDataset(),this.dataset.filter((user=>Object.keys(user).some((key=>""!==user[key]&&!bannedFilterFields.includes(key)&&user[key].toString().toLowerCase().includes(this.preppedSearchTerm)))))}async filterMatchDataset(){this.profilestringmap=this.profilestringmap||await fetchRequiredStrings(),this.results=this.matchedResults.map((user=>{for(const[key,value]of Object.entries(user)){var _this$profilestringma;const valueString=value.toString().toLowerCase();if(valueString.includes(this.preppedSearchTerm)){user.matchingFieldName=null!==(_this$profilestringma=this.profilestringmap.get(key))&&void 0!==_this$profilestringma?_this$profilestringma:key,user.matchingField=valueString.replace(this.preppedSearchTerm,'<span class="font-weight-bold">'.concat(this.searchTerm,"</span>")),user.link=this.selectOneLink(user.id);break}}return user}))}clickHandler(e){super.clickHandler(e),e.target===this.currentViewAll&&0===e.button&&(window.location=this.selectAllResultsLink())}keyHandler(e){switch(super.keyHandler(e),e.target!==this.currentViewAll||"Enter"!==e.key&&"Space"!==e.key||(window.location=this.selectAllResultsLink()),e.key){case"Enter":case" ":if(document.activeElement===this.searchInput){if(" "===e.key)break;window.location=this.selectAllResultsLink();break}if(document.activeElement===this.clearSearchButton){this.closeSearch();break}e.preventDefault(),window.location=e.target.closest(".dropdown-item").href}}selectAllResultsLink(){return _url.default.relativeUrl("/grade/report/grader/index.php",{id:courseID,searchvalue:this.searchTerm},!1)}selectOneLink(userID){return _url.default.relativeUrl("/grade/report/grader/index.php",{id:courseID,searchvalue:this.searchTerm,userid:userID},!1)}static init(){return new UserSearch}}_exports.default=UserSearch;const fetchRequiredStrings=()=>{const requiredStrings=["username","firstname","lastname","email","city","country","department","institution","idnumber","phone1","phone2"];return(0,_str.get_strings)(requiredStrings.map((key=>({key:key})))).then((stringArray=>new Map(requiredStrings.map(((key,index)=>[key,stringArray[index]])))))};return _exports.default}));

//# sourceMappingURL=search.min.js.map