define("gradereport_grader/search/search_class",["exports","jquery","core/custom_interaction_events","core/utils"],(function(_exports,_jquery,_custom_interaction_events,_utils){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}
/**
   * The class that manages the state of the search.
   *
   * @module    gradereport_grader/search/search_class
   * @copyright 2023 Mathew May <mathew.solutions>
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events);const selectors_component=".user-search",selectors_trigger=".usersearchwidget",selectors_input='[data-action="search"]',selectors_clearSearch='[data-action="clearsearch"]',selectors_dropdown=".usersearchdropdown",selectors_resultitems='[role="option"]',selectors_viewall="#select-all",events=["keydown",_custom_interaction_events.default.events.activate,_custom_interaction_events.default.events.keyboardActivate];return _exports.default=class{constructor(){var _this$searchInput$val;_defineProperty(this,"matchedResults",[]),_defineProperty(this,"searchTerm",""),_defineProperty(this,"preppedSearchTerm",null),_defineProperty(this,"resultNodes",[]),_defineProperty(this,"currentNode",null),_defineProperty(this,"currentViewAll",null),_defineProperty(this,"results",[]),_defineProperty(this,"dataset",null),_defineProperty(this,"component",document.querySelector(selectors_component)),_defineProperty(this,"searchInput",this.component.querySelector(selectors_input)),_defineProperty(this,"searchDropdown",this.component.querySelector(selectors_dropdown)),_defineProperty(this,"$searchButton",(0,_jquery.default)(selectors_trigger)),_defineProperty(this,"clearSearchButton",this.component.querySelector(selectors_clearSearch)),_defineProperty(this,"selectNode",(node=>{node.focus({preventScroll:!0}),this.searchDropdown.scrollTop=node.offsetTop-node.clientHeight/2})),_defineProperty(this,"moveToFirstNode",(()=>{this.resultNodes.length>0&&this.selectNode(this.resultNodes[0])})),_defineProperty(this,"moveToLastNode",(()=>{this.resultNodes.length>0&&this.selectNode(this.resultNodes[this.resultNodes.length-1])})),_defineProperty(this,"moveToNode",(index=>{this.resultNodes.length>0&&this.selectNode(this.resultNodes[index])})),this.searchTerm=null!==(_this$searchInput$val=this.searchInput.value)&&void 0!==_this$searchInput$val?_this$searchInput$val:"",this.registerClickHandlers(),this.registerKeyHandlers(),this.registerInputHandlers()}fetchDataset(){throw new Error("fetchDataset() must be implemented in ".concat(this.constructor.name))}filterDataset(){throw new Error("filterDataset() must be implemented in ".concat(this.constructor.name))}filterMatchDataset(){throw new Error("filterMatchDataset() must be implemented in ".concat(this.constructor.name))}renderDropdown(){throw new Error("renderDropdown() must be implemented in ".concat(this.constructor.name))}closeSearch(){this.toggleDropdown(),this.clearSearchButton.classList.add("d-none"),this.searchInput.value=""}toggleDropdown(){let on=arguments.length>0&&void 0!==arguments[0]&&arguments[0];(0,_jquery.default)(this.component).dropdown("toggle"),this.$searchButton.attr("aria-expanded",on),on?(this.searchDropdown.classList.add("show"),(0,_jquery.default)(this.searchDropdown).show()):(this.searchDropdown.classList.remove("show"),(0,_jquery.default)(this.searchDropdown).hide())}updateNodes(){this.resultNodes=[...this.component.querySelectorAll(selectors_resultitems)],this.currentNode=this.resultNodes.find((r=>r.id===document.activeElement.id)),this.currentViewAll=this.component.querySelector(selectors_viewall)}registerClickHandlers(){this.$searchButton.on("click",(()=>{this.toggleDropdown()})),this.component.addEventListener("click",this.clickHandler.bind(this)),document.addEventListener("click",(e=>{!e.target.closest(selectors_component)&&this.searchDropdown.classList.contains("show")&&this.toggleDropdown()}))}registerKeyHandlers(){_custom_interaction_events.default.define(document,events),events.forEach((event=>{this.component.addEventListener(event,this.keyHandler.bind(this))}))}registerInputHandlers(){this.searchInput.addEventListener("input",(0,_utils.debounce)((async()=>{this.searchTerm=this.searchInput.value,""===this.searchTerm?(this.toggleDropdown(),this.clearSearchButton.classList.add("d-none")):(this.clearSearchButton.classList.remove("d-none"),await this.renderAndShow())}),300))}async renderAndShow(){this.preppedSearchTerm=this.searchTerm.toLowerCase(),this.matchedResults=await this.filterDataset(),await this.renderDropdown(await this.filterMatchDataset()),this.toggleDropdown(!0)}keyUpDown(direction,e){e.preventDefault(),e.stopPropagation(),document.activeElement===this.searchInput&&this.resultNodes.length>0&&(-1===direction?this.moveToLastNode():this.moveToFirstNode());const index=this.resultNodes.indexOf(this.currentNode);this.currentNode&&(-1===direction?0===index?this.moveToLastNode():this.moveToNode(index-1):index+1>=this.resultNodes.length?this.moveToFirstNode():this.moveToNode(index+1))}clickHandler(e){this.updateNodes(),e.target.closest(".dropdown-item")&&0===e.button&&(window.location=e.target.closest(".dropdown-item").href),e.target.closest(selectors_clearSearch)&&0===e.button&&(this.closeSearch(),this.searchInput.focus({preventScroll:!0})),e.target.closest(selectors_input)&&""!==this.searchTerm&&0===e.button&&this.renderAndShow()}keyHandler(e){switch(this.updateNodes(),e.key){case"ArrowUp":this.keyUpDown(-1,e);break;case"ArrowDown":this.keyUpDown(1,e);break;case"Home":e.preventDefault(),this.moveToFirstNode();break;case"End":e.preventDefault(),this.moveToLastNode();break;case"Escape":this.toggleDropdown(),this.searchInput.focus({preventScroll:!0});break;case"Tab":e.target.closest(selectors_clearSearch)&&(this.currentViewAll?(e.preventDefault(),this.currentViewAll.focus({preventScroll:!0})):this.closeSearch()),e.target.closest(selectors_viewall)&&this.closeSearch()}}},_exports.default}));

//# sourceMappingURL=search_class.min.js.map