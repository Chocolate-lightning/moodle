{"version":3,"file":"search_class.min.js","sources":["../../src/search/search_class.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport $ from 'jquery';\nimport CustomEvents from \"core/custom_interaction_events\";\nimport {debounce} from 'core/utils';\n\n/**\n * The class that manages the state of the search.\n *\n * @module    gradereport_grader/search/search_class\n * @copyright 2023 Mathew May <mathew.solutions>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// Define our standard lookups.\nconst selectors = {\n    component: '.user-search',\n    trigger: '.usersearchwidget',\n    input: '[data-action=\"search\"]',\n    clearSearch: '[data-action=\"clearsearch\"]',\n    dropdown: '.usersearchdropdown',\n    resultitems: '[role=\"option\"]',\n    viewall: '#select-all',\n};\n\n// Reused variables for the class.\nconst events = [\n    'keydown',\n    CustomEvents.events.activate,\n    CustomEvents.events.keyboardActivate\n];\nconst UP = -1;\nconst DOWN = 1;\n\nexport default class {\n    // The results from the called filter function.\n    matchedResults = [];\n\n    // What did the user search for?\n    searchTerm = '';\n\n    // What did the user search for as a lowercase.\n    preppedSearchTerm = null;\n\n    // The DOM nodes after the dropdown render.\n    resultNodes = [];\n\n    // Where does the user currently have focus?\n    currentNode = null;\n\n    // The current node for the view all link.\n    currentViewAll = null;\n\n    results = [];\n\n    dataset = null;\n\n    // DOM nodes that persist.\n    component = document.querySelector(selectors.component);\n    searchInput = this.component.querySelector(selectors.input);\n    searchDropdown = this.component.querySelector(selectors.dropdown);\n    $searchButton = $(selectors.trigger);\n    clearSearchButton = this.component.querySelector(selectors.clearSearch);\n    $component = $(this.component);\n\n    constructor() {\n        this.searchTerm = this.searchInput.value ?? '';\n        // Begin handling the base search component.\n        this.registerClickHandlers();\n        this.registerKeyHandlers();\n        this.registerInputHandlers();\n    }\n\n    /**\n     * Stub out a required function.\n     */\n    fetchDataset() {\n        throw new Error(`fetchDataset() must be implemented in ${this.constructor.name}`);\n    }\n\n    /**\n     * Stub out a required function.\n     */\n    filterDataset() {\n        throw new Error(`filterDataset() must be implemented in ${this.constructor.name}`);\n    }\n\n    /**\n     * Stub out a required function.\n     */\n    filterMatchDataset() {\n        throw new Error(`filterMatchDataset() must be implemented in ${this.constructor.name}`);\n    }\n\n    /**\n     * Stub out a required function.\n     */\n    renderDropdown() {\n        throw new Error(`renderDropdown() must be implemented in ${this.constructor.name}`);\n    }\n\n    /**\n     * When called, close the dropdown and reset the input field attributes.\n     */\n    closeSearch() {\n        this.toggleDropdown();\n        // Hide the \"clear\" search button search bar.\n        this.clearSearchButton.classList.add('d-none');\n        // Clear the entered search query in the search bar and hide the search results container.\n        this.searchTerm = \"\";\n        this.searchInput.value = \"\";\n    }\n\n    /**\n     * When called, update the dropdown fields.\n     *\n     * @param {Boolean} on Flag to toggle hiding or showing values.\n     */\n    toggleDropdown(on = false) {\n        this.$component.dropdown('toggle');\n        this.$searchButton.attr('aria-expanded', on);\n        if (on) {\n            this.searchDropdown.classList.add('show');\n            $(this.searchDropdown).show();\n        } else {\n            this.searchDropdown.classList.remove('show');\n            $(this.searchDropdown).hide();\n        }\n    }\n\n    /**\n     * These class members change when a new result set is rendered. So update for fresh data.\n     */\n    updateNodes() {\n        this.resultNodes = [...this.component.querySelectorAll(selectors.resultitems)];\n        this.currentNode = this.resultNodes.find(r => r.id === document.activeElement.id);\n        this.currentViewAll = this.component.querySelector(selectors.viewall);\n    }\n\n    /**\n     * Register clickable event listeners.\n     */\n    registerClickHandlers() {\n        // Prevent the click triggering the dropdown.\n        this.$searchButton.on('click', () => {\n            this.toggleDropdown();\n        });\n\n        // Register click events within the component.\n        this.component.addEventListener('click', this.clickHandler.bind(this));\n\n        // Register a small click event onto the document since we need to check if they are clicking off the component.\n        document.addEventListener('click', (e) => {\n            // Since we are handling dropdowns manually, ensure we can close it when clicking off.\n            if (!e.target.closest(selectors.component) && this.searchDropdown.classList.contains('show')) {\n                this.toggleDropdown();\n            }\n        });\n    }\n\n    /**\n     * Register key event listeners.\n     */\n    registerKeyHandlers() {\n        CustomEvents.define(document, events);\n\n        // Register click events.\n        events.forEach((event) => {\n            this.component.addEventListener(event, this.keyHandler.bind(this));\n        });\n    }\n\n    /**\n     * Register input event listener for the text input area.\n     */\n    registerInputHandlers() {\n        // Register & handle the text input.\n        this.searchInput.addEventListener('input', debounce(async() => {\n            this.searchTerm = this.searchInput.value;\n            // We can also require a set amount of input before search.\n            if (this.searchTerm === '') {\n                this.toggleDropdown();\n                // Hide the \"clear\" search button in the search bar.\n                this.clearSearchButton.classList.add('d-none');\n            } else {\n                // Display the \"clear\" search button in the search bar.\n                this.clearSearchButton.classList.remove('d-none');\n                await this.renderAndShow();\n            }\n        }, 300));\n    }\n\n    /**\n     * A combo method to take the matching fields and render out the results.\n     *\n     * @returns {Promise<void>}\n     */\n    async renderAndShow() {\n        this.preppedSearchTerm = this.searchTerm.toLowerCase();\n        // User has given something for us to filter against.\n        this.matchedResults = await this.filterDataset();\n        // Replace the dropdown node contents and show the results.\n        await this.renderDropdown(await this.filterMatchDataset());\n        // Set the dropdown to open.\n        this.toggleDropdown(true);\n    }\n\n    /**\n     * Set the current focus either on the preceding or next result item.\n     *\n     * @param {Number} direction Is the user moving up or down the resultset?\n     * @param {Event} e The JS event from the event handler.\n     */\n    keyUpDown(direction, e) {\n        e.preventDefault();\n        // Stop Bootstrap from being clever.\n        e.stopPropagation();\n        // Current focus is on the input box so depending on direction, go to the top or the bottom of the displayed results.\n        if (document.activeElement === this.searchInput && this.resultNodes.length > 0) {\n            if (direction === UP) {\n                this.moveToLastNode();\n            } else {\n                this.moveToFirstNode();\n            }\n        }\n        const index = this.resultNodes.indexOf(this.currentNode);\n        if (this.currentNode) {\n            if (direction === UP) {\n                if (index === 0) {\n                    this.moveToLastNode();\n                } else {\n                    this.moveToNode(index - 1);\n                }\n            } else {\n                if (index + 1 >= this.resultNodes.length) {\n                    this.moveToFirstNode();\n                } else {\n                    this.moveToNode(index + 1);\n                }\n            }\n        }\n    }\n\n    /**\n     * The handler for when a user interacts with the component.\n     *\n     * @param {Event} e The triggering event that we are working with.\n     */\n    clickHandler(e) {\n        this.updateNodes();\n\n        // Prevent normal key presses activating this.\n        if (e.target.closest('.dropdown-item') && e.button === 0) {\n            window.location = e.target.closest('.dropdown-item').href;\n        }\n        // The \"clear search\" button is triggered.\n        if (e.target.closest(selectors.clearSearch) && e.button === 0) {\n            this.closeSearch();\n            this.searchInput.focus({preventScroll: true});\n        }\n        // User may have accidentally clicked off the dropdown and wants to reopen it.\n        if (e.target.closest(selectors.input) && this.searchTerm !== '' && e.button === 0) {\n            this.renderAndShow();\n        }\n    }\n\n    /**\n     * The handler for when a user presses a key within the component.\n     *\n     * @param {Event} e The triggering event that we are working with.\n     */\n    keyHandler(e) {\n        this.updateNodes();\n        // Switch the key presses to handle keyboard nav.\n        switch (e.key) {\n            case 'ArrowUp':\n                this.keyUpDown(UP, e);\n                break;\n            case 'ArrowDown':\n                this.keyUpDown(DOWN, e);\n                break;\n            case 'Home':\n                e.preventDefault();\n                this.moveToFirstNode();\n                break;\n            case 'End':\n                e.preventDefault();\n                this.moveToLastNode();\n                break;\n            case 'Escape':\n                this.toggleDropdown();\n                this.searchInput.focus({preventScroll: true});\n                break;\n            case 'Tab':\n                // If the current focus is on clear search, then check if viewall exists then around tab to it.\n                if (e.target.closest(selectors.clearSearch)) {\n                    if (this.currentViewAll) {\n                        e.preventDefault();\n                        this.currentViewAll.focus({preventScroll: true});\n                    } else {\n                        this.closeSearch();\n                    }\n                }\n                // If the current focus is on the view all link, then close the widget then set focus on the next tert nav item.\n                if (e.target.closest(selectors.viewall)) {\n                    this.closeSearch();\n                }\n                break;\n        }\n    }\n\n    /**\n     * Set focus on a given node after parsed through the calling functions.\n     *\n     * @param {HTMLElement} node The node to set focus upon.\n     */\n    selectNode = (node) => {\n        node.focus({preventScroll: true});\n        this.searchDropdown.scrollTop = node.offsetTop - (node.clientHeight / 2);\n    };\n\n    /**\n     * Set the focus on the first node within the array.\n     */\n    moveToFirstNode = () => {\n        if (this.resultNodes.length > 0) {\n            this.selectNode(this.resultNodes[0]);\n        }\n    };\n\n    /**\n     * Set the focus to the final node within the array.\n     */\n    moveToLastNode = () => {\n        if (this.resultNodes.length > 0) {\n            this.selectNode(this.resultNodes[this.resultNodes.length - 1]);\n        }\n    };\n\n    /**\n     * Set focus on any given specified node within the node array.\n     *\n     * @param {Number} index Which item within the array to set focus upon.\n     */\n    moveToNode = (index) => {\n        if (this.resultNodes.length > 0) {\n            this.selectNode(this.resultNodes[index]);\n        }\n    };\n}\n"],"names":["_interopRequireDefault","obj","__esModule","default","_defineProperty","key","value","arg","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","String","Number","_toPrimitive","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","_jquery","_custom_interaction_events","selectors","events","CustomEvents","activate","keyboardActivate","_exports","constructor","_this$searchInput$val","this","document","querySelector","component","$","node","focus","preventScroll","searchDropdown","scrollTop","offsetTop","clientHeight","resultNodes","length","selectNode","index","searchTerm","searchInput","registerClickHandlers","registerKeyHandlers","registerInputHandlers","fetchDataset","Error","concat","name","filterDataset","filterMatchDataset","renderDropdown","closeSearch","toggleDropdown","clearSearchButton","classList","add","on","arguments","$component","dropdown","$searchButton","attr","show","remove","hide","updateNodes","querySelectorAll","currentNode","find","r","id","activeElement","currentViewAll","addEventListener","clickHandler","bind","e","target","closest","contains","define","forEach","event","keyHandler","debounce","async","renderAndShow","preppedSearchTerm","toLowerCase","matchedResults","keyUpDown","direction","preventDefault","stopPropagation","moveToLastNode","moveToFirstNode","indexOf","moveToNode","button","window","location","href"],"mappings":"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"}