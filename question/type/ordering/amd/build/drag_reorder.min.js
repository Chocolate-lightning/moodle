define("qtype_ordering/drag_reorder",["exports","jquery","core/dragdrop","core/key_codes"],(function(_exports,_jquery,_dragdrop,_key_codes){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_dragdrop=_interopRequireDefault(_dragdrop),_key_codes=_interopRequireDefault(_key_codes);class DragReorder{constructor(config){_defineProperty(this,"config",null),_defineProperty(this,"dragStart",null),_defineProperty(this,"originalOrder",null),_defineProperty(this,"itemDragging",null),_defineProperty(this,"itemMoving",null),_defineProperty(this,"orderList",null),_defineProperty(this,"proxy",null),this.config=config,this.config.itemInPage=this.combineSelectors(config.list,config.item),(0,_jquery.default)(this.config.list).on("mousedown touchstart",config.item,function(event){var details=_dragdrop.default.prepare(event);details.start&&this.startDrag(event,details)}.bind(this)),(0,_jquery.default)(this.config.list).on("keydown",config.item,function(event){this.itemMoving=(0,_jquery.default)(event.currentTarget).closest(config.itemInPage),this.originalOrder=this.getCurrentOrder(),this.itemMovedByKeyboard(event,this.itemMoving);var newOrder=this.getCurrentOrder();this.arrayEquals(this.originalOrder,newOrder)||this.config.reorderDone(this.itemMoving.closest(this.config.list),this.itemMoving,newOrder)}.bind(this)),(0,_jquery.default)(this.config.itemInPage).attr("tabindex","0")}startDrag(event,details){this.orderList=(0,_jquery.default)(this.config.list),this.dragStart={time:(new Date).getTime(),x:details.x,y:details.y},this.itemDragging=(0,_jquery.default)(event.currentTarget).closest(this.config.itemInPage),void 0!==this.config.reorderStart&&this.config.reorderStart(this.itemDragging.closest(this.config.list),this.itemDragging),this.originalOrder=this.getCurrentOrder(),this.proxy=(0,_jquery.default)(this.config.proxyHtml.replace("%%ITEM_HTML%%",this.itemDragging.html()).replace("%%ITEM_CLASS_NAME%%",this.itemDragging.attr("class")).replace("%%LIST_CLASS_NAME%%",this.orderList.attr("class"))),(0,_jquery.default)(document.body).append(this.proxy),this.proxy.css("position","absolute"),this.proxy.css(this.itemDragging.offset()),this.proxy.width(this.itemDragging.outerWidth()),this.proxy.height(this.itemDragging.outerHeight()),this.itemDragging.addClass(this.config.itemMovingClass),this.updateProxy(),_dragdrop.default.start(event,this.proxy,this.dragMove.bind(this),this.dragEnd.bind(this))}dragMove(){var list=this.itemDragging.closest(this.config.list),closestItem=null,closestDistance=null;if(list.find(this.config.item).each(function(index,element){var distance=this.distanceBetweenElements(element,this.proxy);(null===closestItem||distance<closestDistance)&&(closestItem=(0,_jquery.default)(element),closestDistance=distance)}.bind(this)),closestItem[0]!==this.itemDragging[0]){var offsetValue=0;this.midY(this.proxy)<this.midY(closestItem)?(offsetValue=20,window.console.log("For midY(proxy) < midY(closestItem) offset is: "+offsetValue)):(offsetValue=-20,window.console.log("For midY(proxy) < midY(closestItem) offset is: "+offsetValue)),this.midY(this.proxy)+offsetValue<this.midY(closestItem)?this.itemDragging.insertBefore(closestItem):this.itemDragging.insertAfter(closestItem),this.updateProxy()}}updateProxy(){for(var items=this.itemDragging.closest("ol, ul").find("li"),count=items.length,i=0;i<count;++i)if(this.itemDragging[0]===items[i]){this.proxy.find("li").attr("value",i+1);break}}combineSelectors(outer,inner){var combined=[];return outer.split(",").forEach((function(firstSelector){inner.split(",").forEach((function(secondSelector){combined.push(firstSelector.trim()+" "+secondSelector.trim())}))})),combined.join(", ")}dragEnd(x,y){void 0!==this.config.reorderEnd&&this.config.reorderEnd(this.itemDragging.closest(this.config.list),this.itemDragging);var newOrder=this.getCurrentOrder();this.arrayEquals(this.originalOrder,newOrder)?(new Date).getTime()-this.dragStart.time<500&&Math.abs(this.dragStart.x-x)<10&&Math.abs(this.dragStart.y-y)<10&&this.itemDragging[0].focus():this.config.reorderDone(this.itemDragging.closest(this.config.list),this.itemDragging,newOrder),this.proxy.remove(),this.proxy=null,this.itemDragging.removeClass(this.config.itemMovingClass),this.itemDragging=null,this.dragStart=null}itemMovedByKeyboard(e,current){switch(e.keyCode){case _key_codes.default.space:case _key_codes.default.arrowRight:case _key_codes.default.arrowDown:e.preventDefault(),e.stopPropagation();var next=current.next();next.length&&next.insertBefore(current);break;case _key_codes.default.arrowLeft:case _key_codes.default.arrowUp:e.preventDefault(),e.stopPropagation();var prev=current.prev();prev.length&&prev.insertAfter(current)}}midX(jQuery){return jQuery.offset().left+jQuery.outerWidth()/2}midY(jQuery){return jQuery.offset().top+jQuery.outerHeight()/2}distanceBetweenElements(element1,element2){var e1=(0,_jquery.default)(element1),e2=(0,_jquery.default)(element2),dx=this.midX(e1)-this.midX(e2),dy=this.midY(e1)-this.midY(e2);return Math.sqrt(dx*dx+dy*dy)}getCurrentOrder(){return(this.itemDragging||this.itemMoving).closest(this.config.list).find(this.config.item).map(function(index,item){return this.config.idGetter(item)}.bind(this)).get()}arrayEquals(a1,a2){return a1.length===a2.length&&a1.every((function(v,i){return v===a2[i]}))}static init(sortableid,responseid){new DragReorder({list:"ul#"+sortableid,item:"li.sortableitem",proxyHtml:'<div class="que ordering dragproxy"><ul class="%%LIST_CLASS_NAME%%"><li class="%%ITEM_CLASS_NAME%% item-moving">%%ITEM_HTML%%</li></ul></div>',itemMovingClass:"current-drop",idGetter:function(item){return(0,_jquery.default)(item).attr("id")},nameGetter:function(item){return(0,_jquery.default)(item).text},reorderDone:function(list,item,newOrder){(0,_jquery.default)("input#"+responseid)[0].value=newOrder.join(",")}})}}return _exports.default=DragReorder,_exports.default}));

//# sourceMappingURL=drag_reorder.min.js.map