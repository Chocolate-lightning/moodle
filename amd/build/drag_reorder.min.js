define("qtype_ordering/drag_reorder",["exports","jquery","core/dragdrop","core/key_codes","core/templates","core/notification"],(function(_exports,_jquery,_dragdrop,_key_codes,_templates,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_dragdrop=_interopRequireDefault(_dragdrop),_key_codes=_interopRequireDefault(_key_codes),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);class DragReorder{constructor(config){_defineProperty(this,"config",{reorderStart:void 0,reorderEnd:void 0}),_defineProperty(this,"dragStart",null),_defineProperty(this,"originalOrder",null),_defineProperty(this,"orderList",null),_defineProperty(this,"itemDragging",null),_defineProperty(this,"proxy",null),this.config=config,this.orderList=document.querySelector(this.config.list),this.startListeners(),(0,_jquery.default)(this.combineSelectors(config.list,config.item)).attr("tabindex","0")}startListeners(){const pointerHandle=e=>{if(e.target.closest(this.config.item)){this.itemDragging=(0,_jquery.default)(e.target.closest(this.config.item));const details=_dragdrop.default.prepare(e);details.start&&this.startDrag(e,details)}};this.orderList.addEventListener("mousedown",pointerHandle),this.orderList.addEventListener("touchstart",pointerHandle),this.orderList.addEventListener("keydown",this.itemMovedByKeyboard.bind(this))}startDrag(e,details){this.dragStart={time:(new Date).getTime(),x:details.x,y:details.y},void 0!==this.config.reorderStart&&this.config.reorderStart(this.itemDragging.closest(this.config.list),this.itemDragging),this.originalOrder=this.getCurrentOrder(),_templates.default.renderForPromise("qtype_ordering/proxyhtml",{itemHtml:this.itemDragging.html(),itemClassName:this.itemDragging.attr("class"),listClassName:this.orderList.classList.toString(),proxyStyles:["width: ".concat(this.itemDragging.outerWidth(),"px;"),"height: ".concat(this.itemDragging.outerHeight(),"px;")].join(" ")}).then((_ref=>{let{html:html,js:js}=_ref;this.proxy=(0,_jquery.default)(_templates.default.appendNodeContents(document.body,html,js)[0]),this.proxy.css(this.itemDragging.offset()),this.itemDragging.addClass(this.config.itemMovingClass),this.updateProxy(),_dragdrop.default.start(e,this.proxy,this.dragMove.bind(this),this.dragEnd.bind(this))})).catch(_notification.default.exception)}dragMove(){let closestItem=null,closestDistance=null;if(this.orderList.querySelectorAll(this.config.item).forEach((element=>{const distance=this.distanceBetweenElements(element);(null===closestItem||distance<closestDistance)&&(closestItem=(0,_jquery.default)(element),closestDistance=distance)})),closestItem[0]===this.itemDragging[0])return;const offsetValue=this.midY(this.proxy)<this.midY(closestItem)?20:-20;this.midY(this.proxy)+offsetValue<this.midY(closestItem)?this.itemDragging.insertBefore(closestItem):this.itemDragging.insertAfter(closestItem),this.updateProxy()}updateProxy(){const items=[...this.orderList.querySelectorAll(this.config.item)];for(let i=0;i<items.length;++i)if(this.itemDragging[0]===items[i]){this.proxy.find("li").attr("value",i+1);break}}dragEnd(x,y){void 0!==this.config.reorderEnd&&this.config.reorderEnd(this.itemDragging.closest(this.config.list),this.itemDragging),this.arrayEquals(this.originalOrder,this.getCurrentOrder())?(new Date).getTime()-this.dragStart.time<500&&Math.abs(this.dragStart.x-x)<10&&Math.abs(this.dragStart.y-y)<10&&this.itemDragging[0].focus():this.config.reorderDone(this.itemDragging.closest(this.config.list),this.itemDragging,this.getCurrentOrder()),this.proxy.remove(),this.proxy=null,this.itemDragging.removeClass(this.config.itemMovingClass),this.itemDragging=null,this.dragStart=null}itemMovedByKeyboard(e){if(e.target.closest(this.config.item)){switch(this.itemDragging=(0,_jquery.default)(e.target.closest(this.config.item)),this.originalOrder=this.getCurrentOrder(),e.keyCode){case _key_codes.default.space:case _key_codes.default.arrowRight:case _key_codes.default.arrowDown:e.preventDefault(),e.stopPropagation(),this.itemDragging.next().length&&this.itemDragging.next().insertBefore(this.itemDragging);break;case _key_codes.default.arrowLeft:case _key_codes.default.arrowUp:e.preventDefault(),e.stopPropagation(),this.itemDragging.prev().length&&this.itemDragging.prev().insertAfter(this.itemDragging)}this.arrayEquals(this.originalOrder,this.getCurrentOrder())||this.config.reorderDone(this.itemDragging.closest(this.config.list),this.itemDragging,this.getCurrentOrder())}}combineSelectors(outer,inner){let combined=[];return outer.split(",").forEach((firstSelector=>{inner.split(",").forEach((secondSelector=>{combined.push(firstSelector.trim()+" "+secondSelector.trim())}))})),combined.join(", ")}midX(node){return node.offset().left+node.outerWidth()/2}midY(node){return node.offset().top+node.outerHeight()/2}distanceBetweenElements(element){const[e1,e2]=[(0,_jquery.default)(element),(0,_jquery.default)(this.proxy)],[dx,dy]=[this.midX(e1)-this.midX(e2),this.midY(e1)-this.midY(e2)];return Math.sqrt(dx*dx+dy*dy)}getCurrentOrder(){return this.itemDragging.closest(this.config.list).find(this.config.item).map(((index,item)=>this.config.idGetter(item))).get()}arrayEquals(a1,a2){return a1.length===a2.length&&a1.every(((v,i)=>v===a2[i]))}static init(sortableid,responseid){new DragReorder({list:"ul#"+sortableid,item:"li.sortableitem",itemMovingClass:"current-drop",idGetter:item=>item.id,reorderDone:(list,item,newOrder)=>{(0,_jquery.default)("input#"+responseid)[0].value=newOrder.join(",")}})}}return _exports.default=DragReorder,_exports.default}));

//# sourceMappingURL=drag_reorder.min.js.map