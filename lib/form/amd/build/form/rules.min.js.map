{"version":3,"file":"rules.min.js","sources":["../../src/form/rules.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This file contains a set of rules that elements can be compared against to determine if they should be shown, hidden, etc...\n *\n * @See /lib/pear/HTML/QuickForm/Rule/Compare.php\n * @See https://pear.php.net/manual/en/package.html.html-quickform2.rules.list.php for a list of available rules.\n *\n * @module     core_form/form/rules\n * @copyright  2024 Mathew May <mathew.solutions>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport * as util from './util';\n\nexport default class Rules {\n    /**\n     * @var {Form} form The instance of the form class that has a DOM node & references matched.\n     */\n    form;\n\n    /**\n     * Compare the value of the changed DOM node to the requested rule.\n     *\n     * @param {HTMLFormElement} target The changed DOM node to be compared against the requested rule.\n     * @returns {Map<String, Array>} Actions to be taken along with elements that should be affected.\n     */\n    notchecked(target) {\n        const displayMap = this.form.mapTemplate();\n        let lock = false;\n\n        this.getDependantsOfType(target.name, 'notchecked').forEach((dependant, key) => {\n            lock = Boolean(key) !== target.checked;\n            util.determineDisplayMap(dependant, displayMap, lock);\n        });\n\n        return this.form.displayMapPrune(displayMap);\n    }\n\n    /**\n     * Compare the value of the changed DOM node to the requested rule.\n     *\n     * @param {HTMLFormElement} target The changed DOM node to be compared against the requested rule.\n     * @returns {Map<String, Array>} Actions to be taken along with elements that should be affected.\n     */\n    checked(target) {\n        const displayMap = this.form.mapTemplate();\n        let lock = false;\n\n        this.getDependantsOfType(target.name, 'checked').forEach((dependant, key) => {\n            lock = Boolean(key) === target.checked;\n            util.determineDisplayMap(dependant, displayMap, lock);\n        });\n\n        return this.form.displayMapPrune(displayMap);\n    }\n\n    /**\n     * Compare the value of the changed DOM node to the requested rule.\n     *\n     * @param {HTMLFormElement} target The changed DOM node to be compared against the requested rule.\n     * @returns {Map<String, Array>} Actions to be taken along with elements that should be affected.\n     */\n    eq(target) {\n        const displayMap = this.form.mapTemplate();\n        const rTarget = this.getRadioFieldVal(target);\n        let lock = false;\n\n        this.getDependantsOfType(target.name, 'eq').forEach((dependant, key) => {\n            if (target.type === 'radio') {\n                lock = String(key) === String(rTarget.value);\n                util.determineDisplayMap(dependant, displayMap, lock);\n                return;\n            } else if (target.type === 'hidden' && this.getHiddenCkbs(target)) {\n                // This is the hidden input that is part of an advcheckbox.\n                lock = target.checked === Boolean(key);\n                util.determineDisplayMap(dependant, displayMap, lock);\n                return;\n            } else if (target.type === 'checkbox' && !target.checked) {\n                lock = target.checked === Boolean(key);\n                util.determineDisplayMap(dependant, displayMap, lock);\n                return;\n            }\n            if (target.classList.contains('filepickerhidden')) {\n                lock = !M.form_filepicker.instances[target.id].fileadded;\n                util.determineDisplayMap(dependant, displayMap, lock);\n            } else if (target.tagName.toLowerCase() === 'select' && target.multiple) {\n                // Multiple selects can have one or more value assigned. A pipe (|) is used as a value separator\n                // when multiple values have to be selected at the same time.\n                window.console.error('This is a multiple select', target);\n            } else {\n                lock = target.value === key;\n                util.determineDisplayMap(dependant, displayMap, lock);\n            }\n        });\n\n        return this.form.displayMapPrune(displayMap);\n    }\n\n    /**\n     * Compare the value of the changed DOM node to the requested rule.\n     * @See Moodle has some interesting aliasing ne && noteq, this is also the old \"default\" rule.\n     *\n     * @param {HTMLFormElement} target The changed DOM node to be compared against the requested rule.\n     * @returns {Map<String, Array>} Actions to be taken along with elements that should be affected.\n     */\n    neq(target) {\n        const displayMap = this.form.mapTemplate();\n        const rTarget = this.getRadioFieldVal(target);\n        let lock = false;\n\n        // Get all the aliases of neq and check them all at once.\n        const maps = [\n            ...this.getDependantsOfType(target.name, 'neq')?.entries() ?? [],\n            ...this.getDependantsOfType(target.name, 'ne')?.entries() ?? [],\n            ...this.getDependantsOfType(target.name, 'noteq')?.entries() ?? [],\n        ];\n        const condensedMaps = new Map(maps);\n        condensedMaps.forEach((dependant, key) => {\n            if (target.type === 'radio') {\n                lock = String(key) !== String(rTarget.value);\n                util.determineDisplayMap(dependant, displayMap, lock);\n                return;\n            } else if (target.type === 'hidden' && this.getHiddenCkbs(target)) {\n                // This is the hidden input that is part of an advcheckbox.\n                lock = target.checked !== Boolean(key);\n                util.determineDisplayMap(dependant, displayMap, lock);\n                return;\n            } else if (target.type === 'checkbox' && !target.checked) {\n                lock = target.checked === Boolean(key);\n                util.determineDisplayMap(dependant, displayMap, lock);\n                return;\n            }\n            if (target.classList.contains('filepickerhidden')) {\n                lock = !!M.form_filepicker.instances[target.id].fileadded;\n                util.determineDisplayMap(dependant, displayMap, lock);\n            } else if (target.tagName.toLowerCase() === 'select' && target.multiple) {\n                // Multiple selects can have one or more value assigned. A pipe (|) is used as a value separator\n                // when multiple values have to be selected at the same time.\n                window.console.error('This is a multiple select', target);\n            } else {\n                lock = target.value !== key;\n                util.determineDisplayMap(dependant, displayMap, lock);\n            }\n        });\n\n        return this.form.displayMapPrune(displayMap);\n    }\n\n    /**\n     * Compare the value of the changed DOM node to the requested rule.\n     *\n     * @param {HTMLFormElement} target The changed DOM node to be compared against the requested rule.\n     * @returns {Map<String, Array>} Actions to be taken along with elements that should be affected.\n     */\n    in(target) {\n        const displayMap = this.form.mapTemplate();\n        let lock = false;\n\n        this.getDependantsOfType(target.name, 'in').forEach((dependant, key) => {\n            lock = key.split('|').includes(target.value);\n            util.determineDisplayMap(dependant, displayMap, lock);\n        });\n\n        return this.form.displayMapPrune(displayMap);\n    }\n\n    // Getters of map values & form elements.\n\n    /**\n     * Call off to the Form() to grab the elements that listen to the passed rule for the given element.\n     *\n     * @param {String} element The name of the element to get the dependants for.\n     * @param {String} type The rule type to get the dependants for.\n     * @returns {Array<String>|[]}\n     */\n    getDependantsOfType(element, type) {\n        return this.form.getDependantsOfType(element, type);\n    }\n\n    /**\n     * Radio fields are a bit different, they need to be handled differently.\n     *\n     * @param {HTMLFormElement} target The changed DOM node to find a potential radio field for.\n     * @returns {RadioNodeList|HTMLFormElement}\n     */\n    getRadioFieldVal(target) {\n        return target.type === 'radio' ? this.form.form.elements.namedItem(target.name) : target;\n    }\n\n    /**\n     * A small helper to determine if the advcheckboxes are being used.\n     *\n     * @param {HTMLElement} target The target element to get the hidden checkboxes for.\n     * @returns {boolean} Is this a hidden checkbox?\n     */\n    getHiddenCkbs(target) {\n        return this.form.form.querySelectorAll('input[type=checkbox][name=\"' + target.name + '\"]').length !== 0;\n    }\n\n    /**\n     * Constructor for the Rules class.\n     * @param {Form} form The form object that the rules are being applied to.\n     */\n    constructor(form) {\n        this.form = form;\n    }\n}\n"],"names":["notchecked","target","displayMap","this","form","mapTemplate","lock","getDependantsOfType","name","forEach","dependant","key","Boolean","checked","util","determineDisplayMap","displayMapPrune","eq","rTarget","getRadioFieldVal","type","String","value","getHiddenCkbs","classList","contains","M","form_filepicker","instances","id","fileadded","tagName","toLowerCase","multiple","window","console","error","neq","maps","_this$getDependantsOf2","entries","_this$getDependantsOf4","_this$getDependantsOf6","Map","in","split","includes","element","elements","namedItem","querySelectorAll","length","constructor"],"mappings":"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"}