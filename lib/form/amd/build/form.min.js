define("core_form/form",["exports","./changechecker","./submit","./form/rules","./form/display","core/pending"],(function(_exports,FormChangeChecker,Submit,_rules,MutateDom,_pending){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _classStaticPrivateFieldSpecGet(receiver,classConstructor,descriptor){return function(receiver,classConstructor){if(receiver!==classConstructor)throw new TypeError("Private static access of wrong provenance")}(receiver,classConstructor),function(descriptor,action){if(void 0===descriptor)throw new TypeError("attempted to "+action+" private static field before its declaration")}(descriptor,"get"),function(receiver,descriptor){if(descriptor.get)return descriptor.get.call(receiver);return descriptor.value}(receiver,descriptor)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,FormChangeChecker=_interopRequireWildcard(FormChangeChecker),Submit=_interopRequireWildcard(Submit),_rules=_interopRequireDefault(_rules),MutateDom=_interopRequireWildcard(MutateDom),_pending=_interopRequireDefault(_pending);class Form{static getInstance(formID){return _classStaticPrivateFieldSpecGet(Form,Form,_instances).get(formID)}static setInstance(formID,instance){_classStaticPrivateFieldSpecGet(Form,Form,_instances).set(formID,instance)}constructor(formID,dependencies){_defineProperty(this,"form",void 0),_defineProperty(this,"dependencies",void 0),_defineProperty(this,"editors",void 0),_defineProperty(this,"staticElements",void 0),_defineProperty(this,"initialDisabledHidden",[]);const pendingPromise=new _pending.default("construction");this.form=document.querySelector("#".concat(formID)),this.dependencies=this.getDependencyMapper(dependencies),this.editors=this.findEditors(),this.staticElements=this.findStaticElements(),this.rules=new _rules.default(this),this.applyInitialState(),this.registerEventListeners(),FormChangeChecker.watchForm(this.form),pendingPromise.resolve(),Form.setInstance(formID,this)}applyInitialState(){[...this.form.elements].forEach((element=>{(element.disabled||element.hidden)&&""!==element.name&&this.initialDisabledHidden.push(element.name)}));const map=this.generateDisplayMap();this.domDispatch(map,!0)}formUpdatedExternally(){const map=this.generateDisplayMap();if(this.domDispatch(map),void 0!==map.get("show")){this.elementNamesToDomNodes(map.get("show")).filter((node=>null!==node)).forEach((node=>{if(this.dependencies.has(node.name)){const secondLvlResult=this.displayMapPrune(this.dispatchDependencyRules(node));this.domDispatch(secondLvlResult)}}))}}generateDisplayMap(){const map=(0,MutateDom.mapTemplate)();return[...this.form.elements].forEach((element=>{if(this.dependencies.has(element.name)){const elDisplayMap=this.displayMapPrune(this.dispatchDependencyRules(element));for(const[key,value]of elDisplayMap)map.get(key).push(...value)}})),map}registerEventListeners(){this.form.addEventListener("change",(async e=>{if("submit"===e.target.type&&(FormChangeChecker.resetFormDirtyState(this.form),Submit.init(e.target.id)),"reset"===e.target.type&&(FormChangeChecker.resetFormDirtyState(this.form),this.form.reset()),this.dependencies.has(e.target.name)){FormChangeChecker.markFormChangedFromNode(e.target);const pendingPromise=new _pending.default("update"),results=this.displayMapPrune(this.dispatchDependencyRules(e.target));if(await this.domDispatch(results),void 0!==results.get("show")){this.elementNamesToDomNodes(results.get("show")).filter((node=>null!==node)).forEach((node=>{const pendingPromise=new _pending.default("updatesecond");if(node instanceof RadioNodeList&&node.forEach((n=>{if(this.dependencies.has(n.name)){const secondLvlResult=this.displayMapPrune(this.dispatchDependencyRules(n));this.domDispatch(secondLvlResult)}})),this.dependencies.has(node.name)){const secondLvlResult=this.displayMapPrune(this.dispatchDependencyRules(node));if(void 0!==results.get("lock")&&void 0!==secondLvlResult.get("unlock")){const keepLocked=secondLvlResult.get("unlock").filter((x=>-1===results.get("lock").indexOf(x.toString())));secondLvlResult.set("unlock",keepLocked);const removeShow=secondLvlResult.get("show").filter((x=>-1===results.get("lock").indexOf(x.toString())));secondLvlResult.set("show",removeShow)}this.domDispatch(secondLvlResult)}pendingPromise.resolve()}))}pendingPromise.resolve()}}))}dispatchDependencyRules(target){const displayMap=(0,MutateDom.mapTemplate)();return this.dependencies.get(target.name).forEach(((dependants,ruleName)=>{(this.rules[ruleName]?this.rules[ruleName](target):this.rules.neq(target)).forEach(((nodeNames,displayOption)=>{displayMap.set(displayOption,[...displayMap.get(displayOption),...nodeNames.values()].flat())}))})),displayMap}displayMapPrune(displayMap){if(void 0!==displayMap.get("unlock")){if(void 0!==displayMap.get("hide")){const hideEvenIfUnlocked=displayMap.get("unlock").filter((x=>-1===displayMap.get("hide").indexOf(x.toString())));displayMap.set("unlock",hideEvenIfUnlocked)}if(void 0!==displayMap.get("lock")){const lockEvenIfUnlocked=displayMap.get("unlock").filter((x=>-1===displayMap.get("lock").indexOf(x.toString())));displayMap.set("unlock",lockEvenIfUnlocked)}}if(void 0!==displayMap.get("show")&&void 0!==displayMap.get("hide")){const hideEvenIfShown=displayMap.get("show").filter((x=>-1===displayMap.get("hide").indexOf(x.toString())));displayMap.set("show",hideEvenIfShown)}for(const[key,value]of displayMap)0===value.length&&displayMap.delete(key);return displayMap}getDependantsOfType(elementName,ruleName){var _this$dependencies$ge;return"undefined"!==this.dependencies.get(elementName)&&null!==(_this$dependencies$ge=this.dependencies.get(elementName).get(ruleName))&&void 0!==_this$dependencies$ge?_this$dependencies$ge:[]}domDispatch(elNamesMap){let firstRun=arguments.length>1&&void 0!==arguments[1]&&arguments[1];(elNamesMap=this.displayMapPrune(elNamesMap)).forEach(((elements,domUpdateOpt)=>{MutateDom[domUpdateOpt]&&(firstRun&&(elements=elements.filter((el=>!this.initialDisabledHidden.includes(el)))),this.elementNamesToDomNodes(elements).forEach((node=>{if(null!==node)if(node instanceof RadioNodeList)node.forEach((el=>{MutateDom[domUpdateOpt](el)}));else if(node.hasAttribute("data-name")){MutateDom[domUpdateOpt](node.closest(".fitem"));[...node.childNodes].filter((el=>["INPUT","SELECT","TEXTAREA","BUTTON","A"].includes(el.tagName))).forEach((el=>{MutateDom[domUpdateOpt](el)}))}else MutateDom[domUpdateOpt](node)})))}))}elementNamesToDomNodes(elementNames){return elementNames.map((element=>this.form.querySelector('[data-groupname="'.concat(element,'"]'))?this.form.querySelector('[data-groupname="'.concat(element,'"]')):this.staticElements.get(element)?this.form.querySelector('[data-name="'.concat(element,'"]')):this.editors.get("".concat(element,"[text]"))?this.form.elements.namedItem("".concat(element,"[text]")):this.form.elements.namedItem(element)?this.form.elements.namedItem(element):this.form.elements.namedItem("id_".concat(element))))}findEditors(){let found=new Map;const fEditors=this.form.querySelectorAll('[data-fieldtype="editor"] textarea');return Array.from(fEditors).forEach((node=>{found.set(node.name,!0)})),found}findStaticElements(){let found=new Map;const fStatic=this.form.querySelectorAll('.fitem [data-fieldtype="static"] .form-control-static');return Array.from(fStatic).forEach((node=>{found.set(node.dataset.name,!0)})),found}getDependencyMapper(dependencies){const elementMap=new Map(Object.entries(dependencies));return elementMap.forEach(((elementrules,key)=>{const ruleMap=new Map(Object.entries(elementrules));ruleMap.forEach(((ruleComparisons,key)=>{const hideDefine=new Map(Object.entries(ruleComparisons));hideDefine.forEach(((action,compVal)=>{Array.isArray(action)&&(action={...action}),hideDefine.set(compVal,action)})),ruleMap.set(key,hideDefine)})),elementMap.set(key,ruleMap)})),elementMap}static init(formID,dependencies){return new Form(formID,dependencies)}}_exports.default=Form;var _instances={writable:!0,value:new Map};return _exports.default}));

//# sourceMappingURL=form.min.js.map