define("core_form/form",["exports","./changechecker","./submit","./form/rules","./form/display","core/pending"],(function(_exports,FormChangeChecker,Submit,_rules,MutateDom,_pending){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,FormChangeChecker=_interopRequireWildcard(FormChangeChecker),Submit=_interopRequireWildcard(Submit),_rules=_interopRequireDefault(_rules),MutateDom=_interopRequireWildcard(MutateDom),_pending=_interopRequireDefault(_pending),M.form2=M.form2||new Map;class Form{constructor(formID,dependencies){_defineProperty(this,"form",void 0),_defineProperty(this,"dependencies",void 0),_defineProperty(this,"editors",void 0),_defineProperty(this,"initialDisabledHidden",[]);const pendingPromise=new _pending.default("construction");this.form=document.querySelector("#".concat(formID)),this.dependencies=this.getDependencyMapper(dependencies),this.editors=this.findEditors(),this.rules=new _rules.default(this),this.applyInitialState(),this.registerEventListeners(),FormChangeChecker.watchForm(this.form),pendingPromise.resolve()}applyInitialState(){[...this.form.elements].forEach((element=>{(element.disabled||element.hidden)&&""!==element.name&&this.initialDisabledHidden.push(element.name)}));const map=this.generateDisplayMap();this.domDispatch(map,!0)}formUpdatedExternally(){const map=this.generateDisplayMap();if(this.domDispatch(map),void 0!==map.get("show")){this.elementNamesToDomNodes(map.get("show")).filter((node=>null!==node)).forEach((node=>{if(this.dependencies.has(node.name)){const secondLvlResult=this.displayMapPrune(this.dispatchDependencyRules(node));this.domDispatch(secondLvlResult)}}))}}generateDisplayMap(){const map=(0,MutateDom.mapTemplate)();return[...this.form.elements].forEach((element=>{if(this.dependencies.has(element.name)){const elDisplayMap=this.displayMapPrune(this.dispatchDependencyRules(element));for(const[key,value]of elDisplayMap)map.get(key).push(...value)}})),map}registerEventListeners(){this.form.addEventListener("change",(async e=>{if("submit"===e.target.type&&(FormChangeChecker.resetFormDirtyState(this.form),Submit.init(e.target.id)),"reset"===e.target.type&&(FormChangeChecker.resetFormDirtyState(this.form),this.form.reset()),this.dependencies.has(e.target.name)){FormChangeChecker.markFormChangedFromNode(e.target);const pendingPromise=new _pending.default("update"),results=this.displayMapPrune(this.dispatchDependencyRules(e.target));if(await this.domDispatch(results),void 0!==results.get("show")){this.elementNamesToDomNodes(results.get("show")).filter((node=>null!==node)).forEach((node=>{const pendingPromise=new _pending.default("updatesecond");if(node instanceof RadioNodeList&&node.forEach((n=>{if(this.dependencies.has(n.name)){const secondLvlResult=this.displayMapPrune(this.dispatchDependencyRules(n));this.domDispatch(secondLvlResult)}})),this.dependencies.has(node.name)){const secondLvlResult=this.displayMapPrune(this.dispatchDependencyRules(node));this.domDispatch(secondLvlResult)}pendingPromise.resolve()}))}pendingPromise.resolve()}}))}dispatchDependencyRules(target){const displayMap=(0,MutateDom.mapTemplate)();return this.dependencies.get(target.name).forEach(((dependants,ruleName)=>{(this.rules[ruleName]?this.rules[ruleName](target):this.rules.neq(target)).forEach(((nodeNames,displayOption)=>{displayMap.set(displayOption,[...displayMap.get(displayOption),...nodeNames.values()].flat())}))})),displayMap}displayMapPrune(displayMap){const hideEvenIfUnlocked=displayMap.get("unlock").filter((x=>-1===displayMap.get("hide").indexOf(x.toString())));displayMap.set("unlock",hideEvenIfUnlocked);const hideEvenIfShown=displayMap.get("show").filter((x=>-1===displayMap.get("hide").indexOf(x.toString())));displayMap.set("show",hideEvenIfShown);for(const[key,value]of displayMap)0===value.length&&displayMap.delete(key);return displayMap}getDependantsOfType(elementName,ruleName){var _this$dependencies$ge;return"undefined"!==this.dependencies.get(elementName)&&null!==(_this$dependencies$ge=this.dependencies.get(elementName).get(ruleName))&&void 0!==_this$dependencies$ge?_this$dependencies$ge:[]}domDispatch(elNamesMap){let firstRun=arguments.length>1&&void 0!==arguments[1]&&arguments[1];elNamesMap.forEach(((elements,domUpdateOpt)=>{MutateDom[domUpdateOpt]&&(firstRun&&(elements=elements.filter((el=>!this.initialDisabledHidden.includes(el)))),this.elementNamesToDomNodes(elements).forEach((node=>{null!==node&&(node instanceof RadioNodeList?node.forEach((el=>{MutateDom[domUpdateOpt](el)})):MutateDom[domUpdateOpt](node))})))}))}elementNamesToDomNodes(elementNames){return elementNames.map((element=>this.form.querySelector('[data-groupname="'.concat(element,'"]'))?this.form.querySelector('[data-groupname="'.concat(element,'"]')):this.editors.get("".concat(element,"[text]"))?this.form.elements.namedItem("".concat(element,"[text]")):this.form.elements.namedItem(element)?this.form.elements.namedItem(element):this.form.elements.namedItem("id_".concat(element))))}findEditors(){let found=new Map;const fEditors=this.form.querySelectorAll('[data-fieldtype="editor"] textarea');return Array.from(fEditors).forEach((node=>{found.set(node.name,!0)})),found}getDependencyMapper(dependencies){const elementMap=new Map(Object.entries(dependencies));return elementMap.forEach(((elementrules,key)=>{const ruleMap=new Map(Object.entries(elementrules));ruleMap.forEach(((ruleComparisons,key)=>{const hideDefine=new Map(Object.entries(ruleComparisons));hideDefine.forEach(((action,compVal)=>{Array.isArray(action)&&(action={...action}),hideDefine.set(compVal,action)})),ruleMap.set(key,hideDefine)})),elementMap.set(key,ruleMap)})),elementMap}static init(formID,dependencies){const instance=new Form(formID,dependencies);return M.form2.set(formID,instance),instance}}return _exports.default=Form,_exports.default}));

//# sourceMappingURL=form.min.js.map